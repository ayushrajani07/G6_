{# Wave 4 migration: prefer enveloped storage_panel (kind=storage) if provided; fallback to snapshot.storage #}
{% set storage_data = (storage_panel.storage if storage_panel and storage_panel.storage else (snapshot.storage if snapshot else None)) %}
{% if storage_data %}
<div class="panel storage-panel">
  <div class="storage-sections">
    <div class="storage-block">
      <h4>CSV</h4>
      <ul>
        <li>Files: {{ storage_data.csv.files_total or '-' }}</li>
        <li>Records: {{ storage_data.csv.records_total or '-' }} {% if storage_data.csv.records_delta is not none %}<span class="delta">(+{{ storage_data.csv.records_delta }})</span>{% endif %}</li>
        <li>Errors: <span class="{% if storage_data.csv.errors_total and storage_data.csv.errors_total > 0 %}bad{% else %}ok{% endif %}">{{ storage_data.csv.errors_total or 0 }}</span></li>
        <li>Disk MB: {{ '%.1f'|format(storage_data.csv.disk_mb) if storage_data.csv.disk_mb is not none else '-' }}</li>
      </ul>
    </div>
    <div class="storage-block">
      <h4>InfluxDB</h4>
      <ul>
        <li>Points: {{ storage_data.influx.points_total or '-' }} {% if storage_data.influx.points_delta is not none %}<span class="delta">(+{{ storage_data.influx.points_delta }})</span>{% endif %}</li>
        <li>Write %: {{ '%.1f'|format(storage_data.influx.write_success_pct) if storage_data.influx.write_success_pct is not none else '-' }}</li>
        <li>Conn: <span class="{% if storage_data.influx.connection == 1 %}ok{% else %}bad{% endif %}">{{ storage_data.influx.connection }}</span></li>
        <li>Latency ms: {{ '%.1f'|format(storage_data.influx.query_latency_ms) if storage_data.influx.query_latency_ms is not none else '-' }}</li>
      </ul>
    </div>
    <div class="storage-block">
      <h4>Backup</h4>
      <ul>
        <li>Files: {{ storage_data.backup.files_total or '-' }}</li>
        <li>Size MB: {{ '%.1f'|format(storage_data.backup.size_mb) if storage_data.backup.size_mb is not none else '-' }}</li>
        <li>Last: {% if storage_data.backup.last_backup_unixtime %}{{ storage_data.backup.last_backup_unixtime|int }}{% else %}-{% endif %}</li>
        <li>Age: {% if storage_data.backup.age_seconds %}{{ (storage_data.backup.age_seconds/60)|int }}m{% else %}-{% endif %}</li>
      </ul>
    </div>
  </div>
</div>
{% else %}
<div class="panel storage-panel"><p>No data.</p></div>
{% endif %}
